!function(e,j,J){"use strict";var Y="ht",k=e[Y],i=k.Default,N=i.def,T=i.getInternal();k.HistoryManager=function(Z){this._histories=[],this.setDataModel(Z)},N(k.HistoryManager,j,{ms_ac:["dataModel","histories","historyIndex","maxHistoryCount","disabled"],ms_fire:1,_historyIndex:-1,_betweenTransaction:0,_maxHistoryCount:200,_disabled:!1,ignoredPropertyMap:{imageLoaded:!0,children:!0,attaches:!0,shape:!0,childChange:!0,agentChange:!0,sourceAgent:!0,targetAgent:!0,edgeGroup:!0,"*":!0},ignoreDataModelPropertyMap:{},beginInteraction:function(){this.beginTransaction()},endInteraction:function(){this.endTransaction()},beginTransaction:function(){if(!this._disabled){var Q=this;Q._betweenTransaction++,1===Q._betweenTransaction&&(Q._transactionHistories={})}},endTransaction:function(){if(!this._disabled){var R=this,c=R._histories;if(R._betweenTransaction>0&&R._betweenTransaction--,0===R._betweenTransaction){if(R._transactionHistories){var y=[];for(var r in R._transactionHistories)y.push(R._transactionHistories[r]);y.length&&(c=c.slice(0,R._historyIndex+1),c.push(y),c.length>R._maxHistoryCount&&(c=c.slice(c.length-R._maxHistoryCount)),R.setHistories(c),R.setHistoryIndex(c.length-1,!0))}delete R._transactionHistories}}},setDataModel:function(M){var c=this,J=c._dataModel;J!==M&&(J&&(delete J._historyManager,J.ump(c.handleDataModelPropertyChange,c),J.umm(c.$5p,c),J.umd(c.$6p,c),J.removeHierarchyChangeListener(c.handleHierarchyChange,c),J.removeIndexChangeListener(c.handleIndexChange,c)),c._dataModel=M,M&&(M._historyManager=c,M.mp(c.handleDataModelPropertyChange,c),M.mm(c.$5p,c),M.md(c.$6p,c),M.addHierarchyChangeListener(c.handleHierarchyChange,c),M.addIndexChangeListener(c.handleIndexChange,c)),c.fp("dataModel",J,M),c.clear())},setHistoryIndex:function(Y,x){var l=this,N=l._historyIndex,X=l._histories.length;if(-1>Y?Y=-1:Y>=X&&(Y=X-1),N!==Y){if(!x){var H=Y-N;H>0?l.$2p(H):0>H&&l.$1p(-H)}l._historyIndex=Y,l.fp("historyIndex",N,Y),l.dataModel&&l.dataModel.onHistoryManagerChanged()}},setMaxHistoryCount:function(U){var j=this,i=j._histories,n=j._maxHistoryCount;(!U||0>=U)&&(U=10),n!==U&&(j._maxHistoryCount=U,j.fp("maxHistoryCount",n,U),i.length>U&&j.clear())},cloneValue:function(v){return k.Default.clone(v)},isPropertyUndoable:function(D){return D&&!this.ignoredPropertyMap[D]},isIndexUndoable:function(){return!1},isDataModelPropertyUndoable:function(C){return C&&!this.ignoreDataModelPropertyMap[C]},$5p:function(m){this.handleChange(m,m.kind)},$6p:function(u){this.handleChange(u,"property")},handleHierarchyChange:function(O){this.handleChange(O,"hierarchy")},handleIndexChange:function(T){this.handleChange(T,"index")},handleDataModelPropertyChange:function(E){this.handleChange(E,"dataModelProperty")},toChildrenInfo:function(h){var g={};return g.data=h,g.children=[],h.eachChild(function(I){g.children.push(this.toChildrenInfo(I))},this),g},restoreChildren:function(v){var O=v.data;v.children.forEach(function(e){var Q=e.data;Q.getParent()!==O&&O.addChild(Q),this._dataModel.contains(Q)||this._dataModel.add(Q),this.restoreChildren(e)},this)},handleChange:function(c,v){var x=this;if(!(x._disabled||x._isUndoRedoing||i.loadingRefGraph)){var W,t=(x._histories,c.data),s=c.property;if(!t||!(t._refGraph||t instanceof k.RefGraph)){if("property"===v)x.isPropertyUndoable(s,t)&&(W={kind:v,data:t,property:s,oldValue:x.cloneValue(c.oldValue,t,s),newValue:x.cloneValue(c.newValue,t,s),event:c});else if("hierarchy"===v||"index"===v&&x.isIndexUndoable(c))W={kind:v,data:t,oldIndex:c.oldIndex,newIndex:c.newIndex,event:c};else if("clear"===v)W={kind:v,json:c.json,event:c};else if("add"===v){if(W={kind:v,data:t,event:c,childrenInfo:this.toChildrenInfo(t),parent:t.getParent()},W.parent){var g=x._dataModel.getSiblings(t);W.siblingsIndex=g.indexOf(t)}t instanceof k.Node&&(W.host=t.getHost(),W.attaches=t.getAttaches()?t.getAttaches().toArray():J),t instanceof k.Edge&&(W.source=t.getSource(),W.target=t.getTarget())}else"remove"===v?W={kind:v,data:t,event:c}:"dataModelProperty"===v&&x.isDataModelPropertyUndoable(s,t)&&(W={kind:v,property:s,oldValue:x.cloneValue(c.oldValue,t,s),newValue:x.cloneValue(c.newValue,t,s),event:c});x.addHistory(W)}}},addHistory:function(E){var G=this;if(E)if(G._betweenTransaction){var x=(E.data?E.data._id:0)+"_"+E.kind+"_"+E.property;if("property"===E.kind||"dataModelProperty"===E.kind){var y=G._transactionHistories[x];y&&(E.oldValue=y.oldValue)}G._transactionHistories[x]=E}else{var H=G._histories;H=H.slice(0,G._historyIndex+1),H.push([E]),H.length>G._maxHistoryCount&&(H=H.slice(H.length-G._maxHistoryCount)),G.setHistories(H),G.setHistoryIndex(H.length-1,!0)}},canUndo:function(){return!this._disabled&&this._historyIndex>=0&&this._historyIndex<this._histories.length},canRedo:function(){return!this._disabled&&this._historyIndex>=-1&&this._historyIndex<this._histories.length-1},undo:function(O){(!O||0>=O)&&(O=1),this.setHistoryIndex(this._historyIndex-O)},$1p:function(s){if(this.canUndo()){var z,G=this,l=G._dataModel,n=G._histories,N=G._historyIndex,W=0;for(G._isUndoRedoing=!0,i.setIsolating(!0);s>0;){if(N>=0&&N<n.length){W++,z=n[N],N--;for(var g=z.length-1;g>=0;g--){var B=z[g],M=B.kind,K=B.data,F=B.property,c=B.event,m=this.cloneValue(B.oldValue,K,F);if(B.undo)B.undo();else if("add"===M)l.remove(K,{keepChildren:!0});else if("remove"===M)l.contains(K)||l.add(K,c.rootsIndex,c.datasIndex);else if("clear"===M)l.deserialize(i.clone(B.json));else if("property"===M)if("parent"===F)m?m.addChild(K,c.oldIndex):(K.setParent(m),c.oldIndex>=0&&l.moveTo(K,c.oldIndex));else{var x=null;0===F.indexOf("a:")?(x="attr",F=F.replace("a:","")):0===F.indexOf("s:")?(x="style",F=F.replace("s:","")):0===F.indexOf("f:")&&(x="field",F=F.replace("f:","")),T.setPropertyValue(K,x,F,m)}else if("dataModelProperty"===M){var x=null;0===F.indexOf("a:")?(x="attr",F=F.replace("a:","")):0===F.indexOf("s:")?(x="style",F=F.replace("s:","")):0===F.indexOf("f:")&&(x="field",F=F.replace("f:","")),T.setPropertyValue(l,x,F,m)}else"hierarchy"===M?l.moveTo(K,B.oldIndex):"index"===M&&l.moveToIndex(K,B.oldIndex)}}s--}i.setIsolating(!1),delete G._isUndoRedoing,G.afterUndo(W)}},afterUndo:function(){},redo:function(A){(!A||0>=A)&&(A=1),this.setHistoryIndex(this._historyIndex+A)},$2p:function(d){if(this.canRedo()){var o,V=this,O=V._dataModel,f=V._histories,Y=V._historyIndex,s=0;for(V._isUndoRedoing=!0,i.setIsolating(!0);d>0;){if(Y>=-1&&Y<f.length-1){s++,Y++,o=f[Y];for(var _=0;_<o.length;_++){var Q=o[_],r=Q.kind,Z=Q.data,u=Q.property,q=Q.event,t=this.cloneValue(Q.newValue,Z,u);if(Q.redo)Q.redo();else if("add"===r)Q.parent&&!Z.getParent()&&Q.parent.addChild(Z,Q.siblingsIndex),O.contains(Z)||O.add(Z,q.rootsIndex,q.datasIndex),this.restoreChildren(Q.childrenInfo),Z instanceof k.Node&&(Z.setHost(Q.host),Q.attaches&&Q.attaches.forEach(function(g){g.setHost(Z)})),Z instanceof k.Edge&&(Z.setSource(Q.source),Z.setTarget(Q.target));else if("remove"===r)O.remove(Z);else if("clear"===r)O.clear();else if("property"===r)if("parent"===u)t?t.addChild(Z,q.newIndex):(Z.setParent(t),q.newIndex>=0&&O.moveTo(Z,q.newIndex));else{var J=null;0===u.indexOf("a:")?(J="attr",u=u.replace("a:","")):0===u.indexOf("s:")?(J="style",u=u.replace("s:","")):0===u.indexOf("f:")&&(J="field",u=u.replace("f:","")),T.setPropertyValue(Z,J,u,t)}else if("dataModelProperty"===r){var J=null;0===u.indexOf("a:")?(J="attr",u=u.replace("a:","")):0===u.indexOf("s:")?(J="style",u=u.replace("s:","")):0===u.indexOf("f:")&&(J="field",u=u.replace("f:","")),T.setPropertyValue(O,J,u,t)}else"hierarchy"===r?O.moveTo(Z,Q.newIndex):"index"===r&&O.moveToIndex(Z,Q.newIndex)}}d--}i.setIsolating(!1),delete V._isUndoRedoing,this.afterRedo(s)}},afterRedo:function(){},clear:function(){this.setHistories([]),this.setHistoryIndex(-1,!0),this._betweenTransaction=0,delete this._transactionHistories}})}("undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:(0,eval)("this"),Object);